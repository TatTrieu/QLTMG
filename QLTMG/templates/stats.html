{% extends 'layout/base.html' %}

{% block header_title %}BẢNG TIN THỐNG KÊ{% endblock %}

{% block content %}
<div class="container-fluid p-0">

    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
        <div class="fw-bold text-secondary">
            <i class="fa-solid fa-calendar-days me-2"></i>
            Dữ liệu ngày: <span class="text-primary">{{ current_date }}</span>
            {% if current_class_obj %}
            <span class="mx-2">|</span> Lớp: <span class="text-primary">{{ current_class_obj.name }}</span>
            {% endif %}
        </div>

        <form class="d-flex gap-2" method="get">
            <input type="date" name="date" class="form-control form-control-sm" value="{{ current_date }}"
                   style="width: 150px;">

            {% if current_user.role.name == 'ADMIN' %}
            <select name="class_id" class="form-select form-select-sm" style="width: 200px;">
                <option value="all">-- Toàn trường --</option>
                {% for c in classes %}
                <option value="{{ c.id }}" {% if current_class_obj and current_class_obj.id== c.id %}selected{% endif
                        %}>
                    {{ c.name }}
                </option>
                {% endfor %}
            </select>
            {% endif %}

            <button class="btn btn-primary btn-sm px-3">
                <i class="fa-solid fa-filter"></i> Xem
            </button>
        </form>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3 text-primary">
                        <i class="fa-solid fa-child fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Tổng Sĩ Số</h6>
                        <h4 class="mb-0 fw-bold">{{ data.total_students }} Bé</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle me-3 text-success">
                        <i class="fa-solid fa-check-circle fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Đã Đóng Phí</h6>
                        <h4 class="mb-0 fw-bold">{{ data.paid_count }} Trẻ</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-circle me-3 text-danger">
                        <i class="fa-solid fa-triangle-exclamation fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Chưa Đóng Phí</h6>
                        <h4 class="mb-0 fw-bold text-danger">{{ data.unpaid_count }} Trẻ</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3 text-info">
                        <i class="fa-solid fa-calendar-xmark fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-muted mb-1">Vắng Ngày Này</h6>

                        <h4 class="mb-0 fw-bold">{{ data.absent_total }} Bé</h4>

                        {% if data.absent_permission > 0 %}
                        <small class="text-muted fst-italic" style="font-size: 0.85rem;">
                            (Có phép: <span class="fw-bold text-success">{{ data.absent_permission }}</span>)
                        </small>
                        {% else %}
                        <small class="text-muted" style="font-size: 0.85rem;">(Không có phép)</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold py-3">
                    <i class="fa-solid fa-chart-pie me-2 text-primary"></i>
                    Tình hình Thu Phí Tháng {{ data.month_display }}
                </div>
                <div class="card-body d-flex justify-content-center">
                    <div style="width: 300px; height: 300px;">
                        <canvas id="tuitionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold py-3 d-flex justify-content-between">
                    <span>
                        <i class="fa-solid fa-list-ol me-2 text-danger"></i>
                        Danh Sách Cần Nhắc Phí (Top 5)
                    </span>
                    <small class="text-muted fw-normal">Tháng {{ data.month_display }}</small>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% if data.debtors %}
                        {% for r in data.debtors %}
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div>
                                <span class="fw-bold text-dark">{{ loop.index }}. {{ r.student.name }}</span>
                                <br>
                                <small class="text-muted">
                                    <i class="fa-solid fa-user-group"></i> PH: {{ r.student.parent_name }}
                                </small>
                            </div>
                            <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 py-2">
                                    Nợ: {{ "{:,.0f}".format(r.total_due - r.paid_amount) }}đ
                                </span>
                        </li>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fa-solid fa-medal fa-3x text-warning mb-3"></i>
                            <p class="text-muted">Tuyệt vời! Lớp này đã hoàn thành 100% học phí.</p>
                        </div>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-1 mb-5">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold py-3">
                    <i class="fa-solid fa-users me-2 text-info"></i>
                    Sĩ Số Hiện Tại / Chỉ Tiêu
                </div>
                <div class="card-body">
                    {% set class_limit = settings['MAX_STUDENT'] | int if settings and settings.get('MAX_STUDENT') else
                    30 %}

                    {% if current_class_obj %}
                    {% set target_count = class_limit %}
                    {% set label_text = "Học Sinh (Max)" %}
                    {% set info_text = "Dựa trên quy định sĩ số tối đa của lớp (" ~ class_limit ~ " trẻ)." %}
                    {% else %}
                    {% set total_classes = classes | length %}
                    {% set target_count = class_limit * total_classes %}

                    {% set label_text = "Tổng Chỉ Tiêu" %}
                    {% set info_text = "Tổng sức chứa hiện tại của " ~ total_classes ~ " lớp học (" ~ class_limit ~ "
                    trẻ/lớp)." %}
                    {% endif %}

                    {% if target_count > 0 %}
                    {% set percent = (data.total_students / target_count * 100) | round %}
                    {% else %}
                    {% set percent = 0 %}
                    {% endif %}

                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-primary">{{ data.total_students }} Bé</span>
                        <span class="text-muted">{{ target_count }} {{ label_text }}</span>
                    </div>

                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated {% if percent > 100 %}bg-danger{% endif %}"
                             role="progressbar"
                             style="width: {{ percent }}%;"
                             aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100">
                            {{ percent }}%
                        </div>
                    </div>
                    <small class="text-muted mt-3 d-block">
                        <i class="fa-solid fa-circle-info"></i>
                        {{ info_text }}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white fw-bold py-3">
                    <i class="fa-solid fa-venus-mars me-2 text-primary"></i>
                    Tỷ Lệ Giới Tính
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="height: 250px;">
                    <div style="width: 250px;">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // 1. Biểu đồ Thu phí (Pie Chart)
    const ctxTuition = document.getElementById('tuitionChart');
    if (ctxTuition) {
        new Chart(ctxTuition, {
            type: 'pie',
            data: {
                labels: ['Đã thu', 'Chưa thu'],
                datasets: [{
                    data: [{{ data.paid_count }}, {{ data.unpaid_count }}],
                    backgroundColor: ['#2ecc71', '#e74c3c'], // Xanh lá / Đỏ
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // 2. Biểu đồ Giới tính (Doughnut Chart)
    const ctxGender = document.getElementById('genderChart');
    if (ctxGender) {
        new Chart(ctxGender, {
            type: 'doughnut',
            data: {
                labels: ['Nam', 'Nữ'],
                datasets: [{
                    data: [{{ data.gender_male }}, {{ data.gender_female }}],
                    backgroundColor: ['#3498db', '#9b59b6'], // Xanh dương / Tím
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }
</script>
{% endblock %}